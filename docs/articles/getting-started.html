<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Getting started using estimatr • estimatr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../">estimatr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/getting-started.html">Getting Started</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Technical Notes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/mathematical-notes.html">Mathematical Notes</a>
    </li>
    <li>
      <a href="../articles/benchmarking-estimatr.html">Simulations - Speed Comparisons</a>
    </li>
    <li>
      <a href="../articles/simulations-ols-variance.html">Simulations - OLS and Variance</a>
    </li>
    <li>
      <a href="../articles/simulations-debiasing-dim.html">Simulations - Debiasing Difference-in-Means</a>
    </li>
    <li>
      <a href="../articles/stata-wls-hat.html">How Stata's hat matrix differs with weights</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="http://discuss.declaredesign.org">Ask for Help</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="http://declaredesign.org">DeclareDesign</a>
    </li>
    <li>
      <a href="http://randomizr.declaredesign.org">randomizr</a>
    </li>
    <li>
      <a href="http://fabricatr.declaredesign.org">fabricatr</a>
    </li>
    <li>
      <a href="http://estimatr.declaredesign.org">estimatr</a>
    </li>
  </ul>
</li>
<li>
  <a href="http://declaredesign.org">DeclareDesign home</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a></a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Getting started using estimatr</h1>
                        <h4 class="author">Luke Sonnet</h4>
            
          </div>

    
    
<div class="contents">
<p><strong>estimatr</strong> is a package in R dedicated to providing <a href="/R/estimatr/articles/benchmarking-estimatr.html">fast</a> estimators that take into consideration designs often used by social scientists. Estimators are statistical methods for estimating quantities of interest like treatment effects or regression parameters. Many of the estimators included with the R programming language or popular R packages are slow and have default settings that lead to statistically inappropriate estimates. Certain estimators that reflect cutting-edge advances in statistics are not yet implemented in R packages for convenient use. <strong>estimatr</strong> is designed to solve these problems and provide estimators tuned for design-based inference.</p>
<p>The most up-to-date version of this vignette can be found on the <a href="/R/estimatr/articles/getting-started.html">DeclareDesign website here</a>.</p>
<div id="estimators" class="section level1">
<h1 class="hasAnchor">
<a href="#estimators" class="anchor"></a>Estimators</h1>
<p>The current estimators we provide are:</p>
<ul>
<li>
<a href="#lm_robust"><code>lm_robust</code></a> - for fitting linear models with heteroskedasticity/cluster-robust standard errors</li>
<li>
<a href="#lm_lin"><code>lm_lin</code></a> - a wrapper for <code><a href="../reference/lm_robust.html">lm_robust()</a></code> to simplify interacting centered pre-treatment covariates with a treatment variable</li>
<li>
<a href="#iv_robust"><code>iv_robust</code></a> - two stage least squares estimation of instrumental variables regression</li>
<li>
<a href="#difference_in_means"><code>difference_in_means</code></a> - for estimating differences in means with appropriate standard errors for unit-randomized, cluster-randomized, block-randomized, matched-pair randomized, and matched-pair clustered designs</li>
<li>
<a href="#horvitz_thompson"><code>horvitz_thompson</code></a> - for estimating average treatment effects taking into consideration treatment probabilities or sampling probabilities for simple and cluster randomized designs</li>
</ul>
<p>I first create some sample data to demonstrate how to use each of these estimators.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(estimatr)

<span class="co"># Example dataset to be used throughout built using fabricatr and randomizr</span>
<span class="kw">library</span>(fabricatr)
<span class="kw">library</span>(randomizr)
dat &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fabricatr/topics/fabricate">fabricate</a></span>(
  <span class="dt">N =</span> <span class="dv">100</span>,                        <span class="co"># sample size</span>
  <span class="dt">x =</span> <span class="kw">runif</span>(N, <span class="dv">0</span>, <span class="dv">1</span>),             <span class="co"># pre-treatment covariate</span>
  <span class="dt">y0 =</span> <span class="kw">rnorm</span>(N, <span class="dt">mean =</span> x),        <span class="co"># control potential outcome</span>
  <span class="dt">y1 =</span> y0 <span class="op">+</span><span class="st"> </span><span class="fl">0.35</span>,                 <span class="co"># treatment potential outcome</span>
  <span class="dt">z =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/randomizr/topics/complete_ra">complete_ra</a></span>(N),             <span class="co"># complete random assignment to treatment</span>
  <span class="dt">y =</span> <span class="kw">ifelse</span>(z, y1, y0),          <span class="co"># observed outcome</span>

  <span class="co"># We will also consider clustered data</span>
  <span class="dt">clust =</span> <span class="kw">sample</span>(<span class="kw">rep</span>(letters[<span class="dv">1</span><span class="op">:</span><span class="dv">20</span>], <span class="dt">each =</span> <span class="dv">5</span>)),
  <span class="dt">z_clust =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/randomizr/topics/cluster_ra">cluster_ra</a></span>(clust),
  <span class="dt">y_clust =</span> <span class="kw">ifelse</span>(z_clust, y1, y0)
)

<span class="kw">head</span>(dat)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">ID</th>
<th align="right">x</th>
<th align="right">y0</th>
<th align="right">y1</th>
<th align="right">z</th>
<th align="right">y</th>
<th align="left">clust</th>
<th align="right">z_clust</th>
<th align="right">y_clust</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">001</td>
<td align="right">0.91</td>
<td align="right">1.24</td>
<td align="right">1.6</td>
<td align="right">0</td>
<td align="right">1.24</td>
<td align="left">k</td>
<td align="right">1</td>
<td align="right">1.59</td>
</tr>
<tr class="even">
<td align="left">002</td>
<td align="right">0.94</td>
<td align="right">0.15</td>
<td align="right">0.5</td>
<td align="right">0</td>
<td align="right">0.15</td>
<td align="left">m</td>
<td align="right">0</td>
<td align="right">0.15</td>
</tr>
<tr class="odd">
<td align="left">003</td>
<td align="right">0.29</td>
<td align="right">1.86</td>
<td align="right">2.2</td>
<td align="right">0</td>
<td align="right">1.86</td>
<td align="left">i</td>
<td align="right">0</td>
<td align="right">1.86</td>
</tr>
<tr class="even">
<td align="left">004</td>
<td align="right">0.83</td>
<td align="right">1.47</td>
<td align="right">1.8</td>
<td align="right">1</td>
<td align="right">1.82</td>
<td align="left">r</td>
<td align="right">1</td>
<td align="right">1.82</td>
</tr>
<tr class="odd">
<td align="left">005</td>
<td align="right">0.64</td>
<td align="right">0.73</td>
<td align="right">1.1</td>
<td align="right">1</td>
<td align="right">1.08</td>
<td align="left">c</td>
<td align="right">0</td>
<td align="right">0.73</td>
</tr>
<tr class="even">
<td align="left">006</td>
<td align="right">0.52</td>
<td align="right">0.80</td>
<td align="right">1.1</td>
<td align="right">0</td>
<td align="right">0.80</td>
<td align="left">s</td>
<td align="right">0</td>
<td align="right">0.80</td>
</tr>
</tbody>
</table>
<div id="lm_robust" class="section level2">
<h2 class="hasAnchor">
<a href="#lm_robust" class="anchor"></a><code>lm_robust</code>
</h2>
<p>The <code>estimatr</code> package provides <code><a href="../reference/lm_robust.html">lm_robust()</a></code> to quickly fit linear models with the most common variance estimators and degrees of freedom corrections used in social science. You can easily estimate heteroskedastic standard errors, clustered standard errors, and classical standard errors.</p>
<p>Usage largely mimics <code>lm()</code>, although it defaults to using Eicker-Huber-White robust standard errors, specifically “HC2” standard errors. More about the exact specifications used can be found in the <a href="/R/estimatr/articles/mathematical-notes.html#lm_robust-notes">mathematical notes</a> and more about the estimator can be found on its reference page: <code><a href="../reference/lm_robust.html">lm_robust()</a></code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lmout &lt;-<span class="st"> </span><span class="kw"><a href="../reference/lm_robust.html">lm_robust</a></span>(y <span class="op">~</span><span class="st"> </span>z <span class="op">+</span><span class="st"> </span>x, <span class="dt">data =</span> dat)
<span class="kw">summary</span>(lmout)
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm_robust(formula = y ~ z + x, data = dat)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Standard error type:  HC2 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;             Estimate Std. Error Pr(&gt;|t|) CI Lower CI Upper DF</span>
<span class="co">#&gt; (Intercept)   -0.187      0.207 3.69e-01   -0.598    0.224 97</span>
<span class="co">#&gt; z              0.235      0.187 2.11e-01   -0.135    0.605 97</span>
<span class="co">#&gt; x              1.418      0.286 2.97e-06    0.851    1.985 97</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Multiple R-squared:  0.182 , Adjusted R-squared:  0.165 </span>
<span class="co">#&gt; F-statistic: 10.8 on 2 and 97 DF,  p-value: 5.83e-05</span></code></pre></div>
<p>Users can also easily get the output as a data.frame by using <code><a href="../reference/tidy.html">tidy()</a></code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/tidy.html">tidy</a></span>(lmout)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
<th align="right">p.value</th>
<th align="right">ci.lower</th>
<th align="right">ci.upper</th>
<th align="right">df</th>
<th align="left">outcome</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">(Intercept)</td>
<td align="right">-0.19</td>
<td align="right">0.21</td>
<td align="right">0.37</td>
<td align="right">-0.60</td>
<td align="right">0.22</td>
<td align="right">97</td>
<td align="left">y</td>
</tr>
<tr class="even">
<td align="left">z</td>
<td align="right">0.23</td>
<td align="right">0.19</td>
<td align="right">0.21</td>
<td align="right">-0.14</td>
<td align="right">0.60</td>
<td align="right">97</td>
<td align="left">y</td>
</tr>
<tr class="odd">
<td align="left">x</td>
<td align="right">1.42</td>
<td align="right">0.29</td>
<td align="right">0.00</td>
<td align="right">0.85</td>
<td align="right">1.99</td>
<td align="right">97</td>
<td align="left">y</td>
</tr>
</tbody>
</table>
<p>It is straightforward to do cluster-robust inference, by passing the name of your cluster variable to the <code>clusters =</code> argument. The default variance estimator with clusters is dubbed ‘CR2’ because it is analogous to ‘HC2’ for the clustered case, and utilizes recent advances proposed by <span class="citation">Pustejovsky and Tipton (<a href="#ref-pustejovskytipton2016">2016</a>)</span> to correct hypotheses tests for small samples and work with commonly specified fixed effects and weights. Note that <code><a href="../reference/lm_robust.html">lm_robust()</a></code> is quicker if your cluster variable is a factor!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Standard estimator with clustered assignment 'z_clust'</span>
lmout &lt;-<span class="st"> </span><span class="kw"><a href="../reference/lm_robust.html">lm_robust</a></span>(
  y_clust <span class="op">~</span><span class="st"> </span>z_clust <span class="op">+</span><span class="st"> </span>x,
  <span class="dt">data =</span> dat
)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
<th align="right">p.value</th>
<th align="right">ci.lower</th>
<th align="right">ci.upper</th>
<th align="right">df</th>
<th align="left">outcome</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">(Intercept)</td>
<td align="right">-0.48</td>
<td align="right">0.21</td>
<td align="right">0.02</td>
<td align="right">-0.89</td>
<td align="right">-0.07</td>
<td align="right">97</td>
<td align="left">y_clust</td>
</tr>
<tr class="even">
<td align="left">z_clust</td>
<td align="right">0.81</td>
<td align="right">0.18</td>
<td align="right">0.00</td>
<td align="right">0.46</td>
<td align="right">1.17</td>
<td align="right">97</td>
<td align="left">y_clust</td>
</tr>
<tr class="odd">
<td align="left">x</td>
<td align="right">1.43</td>
<td align="right">0.29</td>
<td align="right">0.00</td>
<td align="right">0.86</td>
<td align="right">2.00</td>
<td align="right">97</td>
<td align="left">y_clust</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># With clustered standard errors</span>
lmout_cl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/lm_robust.html">lm_robust</a></span>(
  y_clust <span class="op">~</span><span class="st"> </span>z_clust <span class="op">+</span><span class="st"> </span>x,
  <span class="dt">data =</span> dat,
  <span class="dt">clusters =</span> clust
)
<span class="kw"><a href="../reference/tidy.html">tidy</a></span>(lmout_cl)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
<th align="right">p.value</th>
<th align="right">ci.lower</th>
<th align="right">ci.upper</th>
<th align="right">df</th>
<th align="left">outcome</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">(Intercept)</td>
<td align="right">-0.48</td>
<td align="right">0.22</td>
<td align="right">0.05</td>
<td align="right">-0.97</td>
<td align="right">0.0</td>
<td align="right">12</td>
<td align="left">y_clust</td>
</tr>
<tr class="even">
<td align="left">z_clust</td>
<td align="right">0.81</td>
<td align="right">0.17</td>
<td align="right">0.00</td>
<td align="right">0.45</td>
<td align="right">1.2</td>
<td align="right">18</td>
<td align="left">y_clust</td>
</tr>
<tr class="odd">
<td align="left">x</td>
<td align="right">1.43</td>
<td align="right">0.34</td>
<td align="right">0.00</td>
<td align="right">0.72</td>
<td align="right">2.1</td>
<td align="right">17</td>
<td align="left">y_clust</td>
</tr>
</tbody>
</table>
<p>Researchers can also replicate Stata’s standard errors by using the <code>se_type =</code> argument both with and without clusters:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lmout_stata &lt;-<span class="st"> </span><span class="kw"><a href="../reference/lm_robust.html">lm_robust</a></span>(
  y_clust <span class="op">~</span><span class="st"> </span>z_clust <span class="op">+</span><span class="st"> </span>x,
  <span class="dt">data =</span> dat,
  <span class="dt">clusters =</span> clust,
  <span class="dt">se_type =</span> <span class="st">"stata"</span>
)
<span class="kw"><a href="../reference/tidy.html">tidy</a></span>(lmout_stata)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
<th align="right">p.value</th>
<th align="right">ci.lower</th>
<th align="right">ci.upper</th>
<th align="right">df</th>
<th align="left">outcome</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">(Intercept)</td>
<td align="right">-0.48</td>
<td align="right">0.22</td>
<td align="right">0.04</td>
<td align="right">-0.95</td>
<td align="right">-0.02</td>
<td align="right">19</td>
<td align="left">y_clust</td>
</tr>
<tr class="even">
<td align="left">z_clust</td>
<td align="right">0.81</td>
<td align="right">0.17</td>
<td align="right">0.00</td>
<td align="right">0.46</td>
<td align="right">1.16</td>
<td align="right">19</td>
<td align="left">y_clust</td>
</tr>
<tr class="odd">
<td align="left">x</td>
<td align="right">1.43</td>
<td align="right">0.33</td>
<td align="right">0.00</td>
<td align="right">0.73</td>
<td align="right">2.13</td>
<td align="right">19</td>
<td align="left">y_clust</td>
</tr>
</tbody>
</table>
<p>Furthermore, users can take advantage of the margins package to get marginal effects, average marginal effects and their standard errors, and more. Similarly, the prediction package from the same author also provides a suite of software for different kinds of predictions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(margins)

lmout_int &lt;-<span class="st"> </span><span class="kw"><a href="../reference/lm_robust.html">lm_robust</a></span>(y <span class="op">~</span><span class="st"> </span>x <span class="op">*</span><span class="st"> </span>z, <span class="dt">data =</span> dat)
mar_int &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/margins/topics/margins">margins</a></span>(lmout_int, <span class="dt">vce =</span> <span class="st">"delta"</span>)
<span class="kw">summary</span>(mar_int)
<span class="co">#&gt;  factor    AME     SE      z      p   lower  upper</span>
<span class="co">#&gt;       x 1.4319 0.2894 4.9468 0.0000  0.8645 1.9992</span>
<span class="co">#&gt;       z 0.2355 0.1864 1.2633 0.2065 -0.1298 0.6008</span>

<span class="kw">library</span>(prediction)
<span class="kw"><a href="http://www.rdocumentation.org/packages/margins/topics/reexports">prediction</a></span>(lmout_int)
<span class="co">#&gt; Average prediction for 100 observations: 0.6742</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/margins/topics/reexports">prediction</a></span>(lmout_int, <span class="dt">at =</span> <span class="kw">list</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span>)))
<span class="co">#&gt; Warning in check_values(data, at): A 'at' value for 'x' is outside observed</span>
<span class="co">#&gt; data range (0.000238896580412984,0.988891728920862)!</span>
<span class="co">#&gt; Average predictions for 100 observations:</span>
<span class="co">#&gt;  value   value</span>
<span class="co">#&gt;   -0.5 -0.8006</span>
<span class="co">#&gt;    0.5  0.6313</span></code></pre></div>
<p>Users who want their regression output in LaTeX or HTML can use the <a href="https://github.com/leifeld/texreg"><code>texreg</code></a> package, which we extend for the output of both the <code><a href="../reference/lm_robust.html">lm_robust()</a></code> and <code><a href="../reference/lm_lin.html">lm_lin()</a></code> functions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(texreg)

<span class="kw"><a href="http://www.rdocumentation.org/packages/texreg/topics/texreg">texreg</a></span>(lmout)</code></pre></div>
</div>
<div id="lm_lin" class="section level2">
<h2 class="hasAnchor">
<a href="#lm_lin" class="anchor"></a><code>lm_lin</code>
</h2>
<p>Adjusting for pre-treatment covariates when using regression to estimate treatment effects is common practice across scientific disciplines. However, <span class="citation">Freedman (<a href="#ref-freedman2008">2008</a>)</span> demonstrated that pre-treatment covariate adjustment biases estimates of average treatment effects. In response, <span class="citation">Lin (<a href="#ref-lin2013">2013</a>)</span> proposed an alternative estimator that would reduce this bias and improve precision. <span class="citation">Lin (<a href="#ref-lin2013">2013</a>)</span> proposes centering all pre-treatment covariates, interacting them with the treatment variable, and regressing the outcome on the treatment, the centered pre-treatment covariates, and all of the interaction terms. This can require a non-trivial amount of data pre-processing.</p>
<p>To facilitate this, we provide a wrapper that processes the data and estimates the model. We dub this estimator the Lin estimator and it can be accessed using <code><a href="../reference/lm_lin.html">lm_lin()</a></code>. This function is a wrapper for <code><a href="../reference/lm_robust.html">lm_robust()</a></code>, and all arguments that work for <code><a href="../reference/lm_robust.html">lm_robust()</a></code> work here. The only difference is in the second argument <code>covariates</code>, where one specifies a right-sided formula with all of your pre-treatment covariates. Below is an example, and more can be seen on the function reference page <a href="#lm_lin"><code>lm_lin</code></a> and some formal notation can be seen in the <a href="/R/estimatr/articles/mathematical-notes.html#lm_lin-notes">mathematical notes</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lml_out &lt;-<span class="st"> </span><span class="kw"><a href="../reference/lm_lin.html">lm_lin</a></span>(
  y <span class="op">~</span><span class="st"> </span>z,
  <span class="dt">covariates =</span> <span class="op">~</span><span class="st"> </span>x,
  <span class="dt">data =</span> dat
)
<span class="kw"><a href="../reference/tidy.html">tidy</a></span>(lml_out)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
<th align="right">p.value</th>
<th align="right">ci.lower</th>
<th align="right">ci.upper</th>
<th align="right">df</th>
<th align="left">outcome</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">(Intercept)</td>
<td align="right">0.55</td>
<td align="right">0.15</td>
<td align="right">0.00</td>
<td align="right">0.25</td>
<td align="right">0.84</td>
<td align="right">96</td>
<td align="left">y</td>
</tr>
<tr class="even">
<td align="left">z</td>
<td align="right">0.24</td>
<td align="right">0.19</td>
<td align="right">0.21</td>
<td align="right">-0.13</td>
<td align="right">0.61</td>
<td align="right">96</td>
<td align="left">y</td>
</tr>
<tr class="odd">
<td align="left">x_c</td>
<td align="right">1.72</td>
<td align="right">0.47</td>
<td align="right">0.00</td>
<td align="right">0.79</td>
<td align="right">2.65</td>
<td align="right">96</td>
<td align="left">y</td>
</tr>
<tr class="even">
<td align="left">z:x_c</td>
<td align="right">-0.58</td>
<td align="right">0.58</td>
<td align="right">0.32</td>
<td align="right">-1.73</td>
<td align="right">0.57</td>
<td align="right">96</td>
<td align="left">y</td>
</tr>
</tbody>
</table>
<p>The output of a <code><a href="../reference/lm_lin.html">lm_lin()</a></code> call can be used with the same methods as <code><a href="../reference/lm_robust.html">lm_robust()</a></code>, including the <a href="https://github.com/leeper/margins"><code>margins</code></a> package.</p>
</div>
<div id="iv_robust" class="section level2">
<h2 class="hasAnchor">
<a href="#iv_robust" class="anchor"></a><code>iv_robust</code>
</h2>
<p>We also implement a two-stage least squares instrumental variables estimator. This estimator provides a simple syntax and fast estimation of standard errors (users can select from the same set of standard error estimators as in <code><a href="../reference/lm_robust.html">lm_robust()</a></code>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># `x` is endogenous variable and `z` is the instrument</span>
iv_out &lt;-<span class="st"> </span><span class="kw"><a href="../reference/iv_robust.html">iv_robust</a></span>(y <span class="op">~</span><span class="st"> </span>x <span class="op">|</span><span class="st"> </span>z, <span class="dt">data =</span> dat)
<span class="kw">summary</span>(iv_out)
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; iv_robust(formula = y ~ x | z, data = dat)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Standard error type:  HC2 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;             Estimate Std. Error Pr(&gt;|t|) CI Lower CI Upper DF</span>
<span class="co">#&gt; (Intercept)     2.18       3.03    0.474    -3.83     8.19 98</span>
<span class="co">#&gt; x              -2.87       5.82    0.623   -14.42     8.68 98</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Multiple R-squared:  -1.43 , Adjusted R-squared:  -1.45 </span>
<span class="co">#&gt; F-statistic: 0.244 on 1 and 98 DF,  p-value: 0.623</span></code></pre></div>
</div>
<div id="difference_in_means" class="section level2">
<h2 class="hasAnchor">
<a href="#difference_in_means" class="anchor"></a><code>difference_in_means</code>
</h2>
<p>While estimating differences in means may seem straightforward, it can become more complicated in designs with blocks or clusters. In these cases, estimators need to average over within-block effects and estimates of variance have to appropriately adjust for features of a design. We provide support for unit-randomized, cluster-randomized, block-randomized, matched-pair randomized, and matched-pair clustered designs. Usage is similar to usage in regression functions. More examples can be seen on the function reference page, <code><a href="../reference/difference_in_means.html">difference_in_means()</a></code>, and the actual estimators used can be found in the <a href="/R/estimatr/articles/mathematical-notes.html#lm_robust-notes">mathematical notes</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Simple version</span>
dim_out &lt;-<span class="st"> </span><span class="kw"><a href="../reference/difference_in_means.html">difference_in_means</a></span>(
  y <span class="op">~</span><span class="st"> </span>z,
  <span class="dt">data =</span> dat
)
<span class="kw"><a href="../reference/tidy.html">tidy</a></span>(dim_out)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
<th align="right">p.value</th>
<th align="right">ci.lower</th>
<th align="right">ci.upper</th>
<th align="right">df</th>
<th align="left">outcome</th>
</tr></thead>
<tbody><tr class="odd">
<td align="left">z</td>
<td align="right">0.16</td>
<td align="right">0.2</td>
<td align="right">0.44</td>
<td align="right">-0.25</td>
<td align="right">0.56</td>
<td align="right">90</td>
<td align="left">y</td>
</tr></tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Clustered version</span>
dim_out_cl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/difference_in_means.html">difference_in_means</a></span>(
  y_clust <span class="op">~</span><span class="st"> </span>z_clust,
  <span class="dt">data =</span> dat,
  <span class="dt">clusters =</span> clust
)
<span class="kw"><a href="../reference/tidy.html">tidy</a></span>(dim_out_cl)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
<th align="right">p.value</th>
<th align="right">ci.lower</th>
<th align="right">ci.upper</th>
<th align="right">df</th>
<th align="left">outcome</th>
</tr></thead>
<tbody><tr class="odd">
<td align="left">z_clust</td>
<td align="right">0.82</td>
<td align="right">0.17</td>
<td align="right">0</td>
<td align="right">0.45</td>
<td align="right">1.2</td>
<td align="right">18</td>
<td align="left">y_clust</td>
</tr></tbody>
</table>
<p>You can check which design was learned and which kind of estimator used by examining the <code>design</code> in the output.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(sleep)
dim_mps &lt;-<span class="st"> </span><span class="kw"><a href="../reference/difference_in_means.html">difference_in_means</a></span>(extra <span class="op">~</span><span class="st"> </span>group, <span class="dt">data =</span> sleep, <span class="dt">blocks =</span> ID)
dim_mps<span class="op">$</span>design
<span class="co">#&gt; [1] "Matched-pair"</span></code></pre></div>
</div>
<div id="horvitz_thompson" class="section level2">
<h2 class="hasAnchor">
<a href="#horvitz_thompson" class="anchor"></a><code>horvitz_thompson</code>
</h2>
<p>Horvitz-Thompson estimators can be used to estimate unbiased treatment effects when the randomization is known. This is particularly useful when there are clusters of different sizes being randomized into treatment or when the treatment assignment is complex and there are dependencies across units in the probability of being treated. Horvitz-Thompson estimators require information about the probability each unit is in treatment and control, as well as the joint probability each unit is in the treatment, in the control, and in opposite treatment conditions.</p>
<p>The estimator we implement here, <code><a href="../reference/horvitz_thompson.html">horvitz_thompson()</a></code> estimates treatment effects for two-armed trials. The easiest way to specify your design and recover the full set of joint and marginal probabilities is to declare your randomization scheme by using <a href="/R/randomizr/reference/declare_ra.html"><code><a href="http://www.rdocumentation.org/packages/randomizr/topics/declare_ra">declare_ra()</a></code></a> from the <a href="/R/randomizr/"><code>randomizr</code></a> package. I show some examples of how to do that below. Again, the technical details for this estimator can be found <a href="/R/estimatr/articles/mathematical-notes.html#horvitz_thompson-notes">here</a> and in references in those notes.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Complete random assignment declaration</span>
crs_decl &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/randomizr/topics/declare_ra">declare_ra</a></span>(
  <span class="dt">N =</span> <span class="kw">nrow</span>(dat),
  <span class="dt">prob =</span> <span class="fl">0.5</span>,
  <span class="dt">simple =</span> <span class="ot">FALSE</span>
)

ht_comp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/horvitz_thompson.html">horvitz_thompson</a></span>(
  y <span class="op">~</span><span class="st"> </span>z,
  <span class="dt">data =</span> dat,
  <span class="dt">ra_declaration =</span> crs_decl
)
<span class="kw"><a href="../reference/tidy.html">tidy</a></span>(ht_comp)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
<th align="right">p.value</th>
<th align="right">ci.lower</th>
<th align="right">ci.upper</th>
<th align="right">df</th>
<th align="left">outcome</th>
</tr></thead>
<tbody><tr class="odd">
<td align="left">z</td>
<td align="right">0.16</td>
<td align="right">0.2</td>
<td align="right">0.44</td>
<td align="right">-0.24</td>
<td align="right">0.56</td>
<td align="right">NA</td>
<td align="left">y</td>
</tr></tbody>
</table>
<p>We can also easily estimate treatment effects from a cluster randomized experiment. Letting <code>horvitz_thompson</code> know that the design is clustered means it uses a collapsed estimator for the variance, described in <span class="citation">Aronow and Middleton (<a href="#ref-aronowmiddleton2013">2013</a>)</span>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Clustered random assignment declaration</span>
crs_clust_decl &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/randomizr/topics/declare_ra">declare_ra</a></span>(
  <span class="dt">N =</span> <span class="kw">nrow</span>(dat),
  <span class="dt">clusters =</span> dat<span class="op">$</span>clust,
  <span class="dt">prob =</span> <span class="fl">0.5</span>,
  <span class="dt">simple =</span> <span class="ot">FALSE</span>
)

ht_clust &lt;-<span class="st"> </span><span class="kw"><a href="../reference/horvitz_thompson.html">horvitz_thompson</a></span>(
  y_clust <span class="op">~</span><span class="st"> </span>z_clust,
  <span class="dt">data =</span> dat,
  <span class="dt">ra_declaration =</span> crs_clust_decl
)
<span class="kw"><a href="../reference/tidy.html">tidy</a></span>(ht_clust)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
<th align="right">p.value</th>
<th align="right">ci.lower</th>
<th align="right">ci.upper</th>
<th align="right">df</th>
<th align="left">outcome</th>
</tr></thead>
<tbody><tr class="odd">
<td align="left">z_clust</td>
<td align="right">0.82</td>
<td align="right">0.25</td>
<td align="right">0</td>
<td align="right">0.33</td>
<td align="right">1.3</td>
<td align="right">NA</td>
<td align="left">y_clust</td>
</tr></tbody>
</table>
<p>You can also build the condition probability matrix (<code>condition_prob_mat =</code>) that <code><a href="../reference/horvitz_thompson.html">horvitz_thompson()</a></code> needs from a declaration from the <a href="/R/randomizr"><code>randomizr</code></a> package—using <code>declaration_to_conditional_pr_mat()</code>—or from a matrix of permutations of the treatment vector—using <code>permutations_to_conditional_pr_mat()</code>. <strong>This is largely intended for use by experienced users. Note, that if one passes a <code>condition_prob_mat</code> that indicates clustering, but does not specify the <code>clusters</code> argument, then the collapsed estimator will not be used.</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># arbitrary permutation matrix</span>
possible_treats &lt;-<span class="st"> </span><span class="kw">cbind</span>(
  <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>),
  <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),
  <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)
)
arb_pr_mat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/permutations_to_condition_pr_mat.html">permutations_to_condition_pr_mat</a></span>(possible_treats)

<span class="co"># Simulating a column to be realized treatment</span>
dat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(
  <span class="dt">z =</span> possible_treats[, <span class="kw">sample</span>(<span class="kw">ncol</span>(possible_treats), <span class="dt">size =</span> <span class="dv">1</span>)],
  <span class="dt">y =</span> <span class="kw">rnorm</span>(<span class="kw">nrow</span>(possible_treats))
)

ht_arb &lt;-<span class="st"> </span><span class="kw"><a href="../reference/horvitz_thompson.html">horvitz_thompson</a></span>(
  y <span class="op">~</span><span class="st"> </span>z,
  <span class="dt">data =</span> dat,
  <span class="dt">condition_pr_mat =</span> arb_pr_mat
)
<span class="kw"><a href="../reference/tidy.html">tidy</a></span>(ht_arb)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
<th align="right">p.value</th>
<th align="right">ci.lower</th>
<th align="right">ci.upper</th>
<th align="right">df</th>
<th align="left">outcome</th>
</tr></thead>
<tbody><tr class="odd">
<td align="left">z</td>
<td align="right">-0.05</td>
<td align="right">0.44</td>
<td align="right">0.91</td>
<td align="right">-0.91</td>
<td align="right">0.81</td>
<td align="right">NA</td>
<td align="left">y</td>
</tr></tbody>
</table>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-aronowmiddleton2013">
<p>Aronow, Peter M, and Joel A Middleton. 2013. “A Class of Unbiased Estimators of the Average Treatment Effect in Randomized Experiments.” <em>Journal of Causal Inference</em> 1 (1): 135–54. <a href="https://doi.org/10.1515/jci-2012-0009" class="uri">https://doi.org/10.1515/jci-2012-0009</a>.</p>
</div>
<div id="ref-freedman2008">
<p>Freedman, David A. 2008. “On Regression Adjustments in Experiments with Several Treatments.” <em>The Annals of Applied Statistics</em>. JSTOR, 176–96. <a href="https://doi.org/10.1214/07-AOAS143" class="uri">https://doi.org/10.1214/07-AOAS143</a>.</p>
</div>
<div id="ref-lin2013">
<p>Lin, Winston. 2013. “Agnostic Notes on Regression Adjustments to Experimental Data: Reexamining Freedman’s Critique.” <em>The Annals of Applied Statistics</em> 7 (1). Institute of Mathematical Statistics: 295–318. <a href="https://doi.org/10.1214/12-AOAS583" class="uri">https://doi.org/10.1214/12-AOAS583</a>.</p>
</div>
<div id="ref-pustejovskytipton2016">
<p>Pustejovsky, James E, and Elizabeth Tipton. 2016. “Small Sample Methods for Cluster-Robust Variance Estimation and Hypothesis Testing in Fixed Effects Models.” <em>Journal of Business &amp; Economic Statistics</em>. Taylor &amp; Francis. <a href="https://doi.org/10.1080/07350015.2016.1247004" class="uri">https://doi.org/10.1080/07350015.2016.1247004</a>.</p>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#estimators">Estimators</a><ul class="nav nav-pills nav-stacked">
<li><a href="#lm_robust"><code>lm_robust</code></a></li>
      <li><a href="#lm_lin"><code>lm_lin</code></a></li>
      <li><a href="#iv_robust"><code>iv_robust</code></a></li>
      <li><a href="#difference_in_means"><code>difference_in_means</code></a></li>
      <li><a href="#horvitz_thompson"><code>horvitz_thompson</code></a></li>
      </ul>
</li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright" style="flex:3;">
  <p>Developed by Graeme Blair, Jasper Cooper, Alexander Coppock, Macartan Humphreys, Luke Sonnet, Neal Fultz.</p>
  <p>Code is licensed under <a href="https://opensource.org/licenses/mit-license.php">MIT</a> license.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
